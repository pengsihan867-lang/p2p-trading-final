<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SolarCoin Ledger</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <header>
      <h1>SolarCoin Day Ledger</h1>
      <p class="subtitle">All transactions generated by the last simulation run</p>
      <p><a href="index.html" style="color:#9aa4c6;text-decoration:underline">‚Üê Back to simulator</a></p>
    </header>

    <section class="cards">
      <div class="card">
        <div class="row" style="gap:12px; flex-wrap: wrap;">
          <label>Filter:</label>
          <select id="typeFilter">
            <option value="all">All</option>
            <option value="internal">Internal only</option>
            <option value="import">External import</option>
            <option value="export">External export</option>
          </select>
          <label>Prosumer:</label>
          <select id="partyFilter">
            <option value="all">All</option>
            <option value="P1">P1</option>
            <option value="P2">P2</option>
            <option value="P3">P3</option>
            <option value="P4">P4</option>
          </select>
          <button id="downloadBtn">Download CSV</button>
          <span id="summary" class="hint"></span>
        </div>
      </div>

      <div class="card" style="overflow:auto;">
        <table id="ledgerTable" style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px; border-bottom:1px solid rgba(255,255,255,0.1)">Time</th>
              <th style="text-align:left; padding:6px; border-bottom:1px solid rgba(255,255,255,0.1)">Type</th>
              <th style="text-align:left; padding:6px; border-bottom:1px solid rgba(255,255,255,0.1)">Seller</th>
              <th style="text-align:left; padding:6px; border-bottom:1px solid rgba(255,255,255,0.1)">Buyer</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid rgba(255,255,255,0.1)">Energy (kWh)</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid rgba(255,255,255,0.1)">Price (SLR/kWh)</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid rgba(255,255,255,0.1)">Amount (SLR)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <script>
      function fmt(v, n = 3) { return Number(v).toFixed(n); }
      function loadLedger() {
        try { return JSON.parse(localStorage.getItem('solarcoin_ledger') || '[]'); } catch { return []; }
      }

      function filterLedger(rows, type, party) {
        return rows.filter(r => {
          const okType = type === 'all' ? true : r.type === type;
          const okParty = party === 'all' ? true : (r.buyer === party || r.seller === party);
          return okType && okParty;
        });
      }

      function render() {
        const all = loadLedger();
        const type = document.getElementById('typeFilter').value;
        const party = document.getElementById('partyFilter').value;
        const rows = filterLedger(all, type, party);

        const tbody = document.querySelector('#ledgerTable tbody');
        tbody.innerHTML = '';
        let sumE = 0, sumA = 0;
        for (const r of rows) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:6px; color:#e6ebff;">${r.label}</td>
            <td style="padding:6px; color:#9aa4c6;">${r.type}</td>
            <td style="padding:6px;">${r.seller}</td>
            <td style="padding:6px;">${r.buyer}</td>
            <td style="padding:6px; text-align:right;">${fmt(r.energy,3)}</td>
            <td style="padding:6px; text-align:right;">${fmt(r.price,3)}</td>
            <td style="padding:6px; text-align:right;">${fmt(r.amount,3)}</td>`;
          tbody.appendChild(tr);
          sumE += r.energy; sumA += r.amount;
        }
        document.getElementById('summary').textContent = `Rows: ${rows.length}, Energy: ${fmt(sumE)} kWh, Amount: ${fmt(sumA)} SLR`;
      }

      function downloadCSV() {
        const all = loadLedger();
        const type = document.getElementById('typeFilter').value;
        const party = document.getElementById('partyFilter').value;
        const rows = filterLedger(all, type, party);
        const header = ['time','type','seller','buyer','energy_kWh','price_SLR_per_kWh','amount_SLR'];
        const csvRows = [header.join(',')];
        for (const r of rows) {
          csvRows.push([r.label, r.type, r.seller, r.buyer, r.energy, r.price, r.amount].join(','));
        }
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'solarcoin_ledger.csv'; a.click(); URL.revokeObjectURL(url);
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('typeFilter').addEventListener('change', render);
        document.getElementById('partyFilter').addEventListener('change', render);
        document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
        render();
      });
    </script>
  </body>
  </html>

